#!/usr/bin/env bash
# Mock ntm for tests. Behavior controlled by NTM_MOCK_SCENARIO.

set -uo pipefail

scenario="${NTM_MOCK_SCENARIO:-ok}"
state_file="${NTM_MOCK_STATE_FILE:-/tmp/ntm_mock_state}"
prompt_file="${NTM_MOCK_LAST_PROMPT:-/tmp/ntm_mock_last_prompt}"

save_session() {
    local session_name="$1"
    printf '%s\n' "$session_name" > "$state_file"
}

load_session() {
    if [[ -f "$state_file" ]]; then
        head -n 1 "$state_file"
    else
        echo ""
    fi
}

session_from_state() {
    local session
    session=$(load_session)
    if [[ -z "$session" ]]; then
        session="test"
    fi
    echo "$session"
}

cmd="${1:-}"
case "$cmd" in
    --robot-status)
        session="$(session_from_state)"
        cat <<EOF
{"success":true,"sessions":{"$session":{"name":"$session","panes":["0.1"]}}}
EOF
        ;;
    --robot-spawn=*)
        session="${cmd#--robot-spawn=}"
        if [[ "$scenario" == "resource_busy" ]]; then
            echo '{"success":false,"error_code":"RESOURCE_BUSY","error":"session already exists"}'
            exit 1
        fi
        if [[ "$scenario" == "spawn_fail" ]]; then
            echo '{"success":false,"error_code":"INTERNAL_ERROR","error":"spawn failed"}'
            exit 1
        fi
        [[ -z "$session" ]] && session="test"
        save_session "$session"
        echo "{\"success\":true,\"session\":\"$session\",\"agents\":[{\"pane\":\"0.1\",\"type\":\"claude\",\"ready\":true}],\"panes\":[\"0.1\"]}"
        ;;
    --robot-send=*)
        if [[ "$scenario" == "agent_error" ]]; then
            echo '{"success":false,"error_code":"AGENT_ERROR","error":"Agent crashed"}'
            exit 3
        fi
        msg=""
        for arg in "$@"; do
            case "$arg" in
                --msg=*) msg="${arg#--msg=}" ;;
            esac
        done
        if [[ -n "$msg" ]]; then
            printf '%s' "$msg" > "$prompt_file"
        fi
        echo '{"success":true,"delivered":true,"chunks":1}'
        ;;
    --robot-wait=*)
        if [[ "$scenario" == "timeout" ]]; then
            echo '{"success":false,"error_code":"TIMEOUT","error":"Timeout waiting for condition"}'
            exit 1
        fi
        if [[ "$scenario" == "agent_error" ]]; then
            echo '{"success":false,"error_code":"AGENT_ERROR","error":"Agent crashed or rate limited"}'
            exit 3
        fi
        echo '{"success":true,"condition":"idle","waited_seconds":45.2}'
        ;;
    --robot-activity=*)
        case "$scenario" in
            rate_limited)
                echo '{"success":true,"state":"WAITING","velocity":0.0,"confidence":0.9,"rate_limited":true}'
                ;;
            generating)
                echo '{"success":true,"state":"GENERATING","velocity":150.5,"confidence":0.9,"rate_limited":false}'
                ;;
            *)
                echo '{"success":true,"state":"WAITING","velocity":0.0,"confidence":0.9,"rate_limited":false}'
                ;;
        esac
        ;;
    --robot-health=*)
        echo '{"success":true,"alerts":[]}'
        ;;
    --robot-interrupt=*)
        echo '{"success":true}'
        ;;
    kill)
        echo "killed"
        ;;
    *)
        echo "mock ntm: unhandled args: $*" >&2
        exit 2
        ;;
esac
